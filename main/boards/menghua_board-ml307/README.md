# 梦话开发板 ML307 4G 版本

## 概述

这是梦话开发板的 4G 版本，基于 ML307 模块提供 4G/LTE 网络连接能力。相比 WiFi 版本，支持双网络模式（WiFi + 4G），适合户外和移动场景使用。

## 硬件特性

- **主控芯片**: ESP32-S3
- **网络连接**: WiFi + ML307 4G/LTE 双网络
- **音频编解码**: ES8311 (输出) + ES7210 (输入)
- **显示屏**: ST7789 1.54寸 TFT LCD (285x240)
- **扩展芯片**: PCA9557 (I/O 扩展)
- **电源管理**: 电池充放电检测、温度监控
- **按键**: 4个按键（KEY、BOOT、音量+、音量-）

## 引脚定义

### 音频接口
- **I2S MCLK**: GPIO38
- **I2S WS**: GPIO13
- **I2S BCLK**: GPIO14
- **I2S DIN**: GPIO12 (麦克风输入)
- **I2S DOUT**: GPIO45 (扬声器输出)

### 音频编解码器 I2C
- **SDA**: GPIO1
- **SCL**: GPIO2
- **ES8311 地址**: 0x18 (默认)
- **ES7210 地址**: 0x82
- **PCA9557 地址**: 0x19

### 显示屏 SPI
- **MOSI**: GPIO40
- **SCLK**: GPIO41
- **DC**: GPIO39
- **RES**: GPIO21
- **背光**: GPIO42 (PWM 控制，反向逻辑)

### ML307 4G 模块
- **RX**: GPIO17
- **TX**: GPIO18
- **波特率**: 115200

### 按键
- **KEY 按键**: GPIO11
- **BOOT 按键**: GPIO0
- **音量+ 按键**: GPIO8
- **音量- 按键**: GPIO7

### 电源管理
- **电池电压检测**: GPIO47 (ADC1_CHANNEL_6)
- **电源控制**: GPIO9

## 功能特性

### 网络功能
- ✅ **WiFi 连接**: 支持 2.4GHz WiFi
- ✅ **4G 连接**: 通过 ML307 模块支持 4G/LTE
- ✅ **双网络切换**: WiFi 和 4G 自动切换
- ✅ **配网模式**: 长按 BOOT 键进入 WiFi 配网

### 音频功能
- ✅ **语音输入**: ES7210 双麦克风阵列
- ✅ **语音输出**: ES8311 音频输出
- ✅ **设备端 AEC**: 支持回声消除 (CONFIG_USE_DEVICE_AEC)
- ✅ **降噪**: NSNet2 降噪算法 (CONFIG_SR_NSN_NSNET2)
- ✅ **音量控制**: 音量+/- 按键，长按最大/静音

### 显示功能
- ✅ **LCD 显示**: 285x240 彩色 TFT 屏幕
- ✅ **表情动画**: 支持 GIF 动画表情
- ✅ **聊天界面**: 显示对话内容
- ✅ **通知提示**: 音量、网络状态等提示
- ✅ **背光控制**: PWM 调光，省电模式自动降低亮度

### 电源管理
- ✅ **电池电量检测**: 实时监控电池电量
- ✅ **充电检测**: 自动识别充电状态
- ✅ **省电模式**: 60秒无操作进入省电，300秒进入睡眠
- ✅ **充电时禁用省电**: 充电时自动禁用省电模式

### 按键功能
- **BOOT 按键**:
  - 单击: 开始/停止对话
  - 长按: 进入 WiFi 配网模式
  - 双击: 切换 AEC 模式 (仅在 CONFIG_USE_DEVICE_AEC 启用时)
- **音量+ 按键**:
  - 单击: 音量 +10
  - 长按: 最大音量
- **音量- 按键**:
  - 单击: 音量 -10
  - 长按: 静音

## 编译配置

### 使用 menuconfig 配置

```bash
idf.py menuconfig
# Xiaozhi Assistant -> Board Type -> 梦话开发板 (ML307 4G)
idf.py build
```

### 使用 release.py 编译

```bash
python scripts/release.py menghua_board-ml307
```

### 配置选项

在 `config.json` 中定义的编译选项：

```json
{
    "target": "esp32s3",
    "builds": [
        {
            "name": "menghua_board-ml307",
            "sdkconfig_append": [
                "CONFIG_USE_DEVICE_AEC=y",
                "CONFIG_SR_NSN_NSNET2=y"
            ]
        }
    ]
}
```

## 与 WiFi 版本的区别

| 特性 | WiFi 版本 | ML307 4G 版本 |
|------|----------|--------------|
| **基类** | `WifiBoard` | `DualNetworkBoard` |
| **网络** | 仅 WiFi | WiFi + 4G 双网络 |
| **ML307 引脚** | 无 | GPIO17(RX), GPIO18(TX) |
| **使用场景** | 家庭/办公室 | 户外/移动场景 |
| **成本** | 低 | 高（含 4G 模块） |
| **流量费用** | 无 | 需要 SIM 卡流量 |

## 使用说明

### 首次使用

1. **插入 SIM 卡**: 将支持 4G 的 SIM 卡插入 ML307 模块
2. **上电启动**: 连接电源或电池
3. **配置网络**:
   - 方式1: 长按 BOOT 键进入 WiFi 配网模式
   - 方式2: 等待 4G 自动连接（需要 SIM 卡）
4. **激活设备**: 根据屏幕提示完成设备激活

### 网络切换

设备会自动在 WiFi 和 4G 之间切换：
- WiFi 可用时优先使用 WiFi
- WiFi 不可用时自动切换到 4G
- 4G 连接失败时尝试 WiFi

### 省电模式

- **60秒无操作**: 降低屏幕亮度，显示睡眠表情
- **300秒无操作**: 进入深度睡眠
- **充电时**: 自动禁用省电模式
- **唤醒**: 按任意按键唤醒

## 故障排除

### 4G 无法连接

1. 检查 SIM 卡是否正确插入
2. 确认 SIM 卡已开通数据流量
3. 检查 ML307 模块供电是否正常
4. 查看串口日志确认 ML307 初始化状态

### WiFi 无法连接

1. 长按 BOOT 键重新配网
2. 确认 WiFi 密码正确
3. 检查路由器是否支持 2.4GHz

### 音频问题

1. 检查音量设置（可能被静音）
2. 确认 ES8311/ES7210 I2C 连接正常
3. 检查 PCA9557 扩展芯片状态

### 显示问题

1. 检查 SPI 连接
2. 确认背光引脚工作正常
3. 调整屏幕参数（DISPLAY_SWAP_XY, DISPLAY_MIRROR_X/Y）

## 技术支持

- **项目主页**: https://github.com/78/xiaozhi-esp32
- **问题反馈**: 提交 GitHub Issue
- **文档**: 查看项目 Wiki

## 许可证

本项目遵循项目主仓库的许可证。

